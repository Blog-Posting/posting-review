# 관계형 데이터베이스의 일관성은 어떻게 유지될까? - 2편 준비 후 커밋 트릭



준비 후 커밋 트릭을 이해하려면 두 가지 사실을 이해야 한다. 

1. 첫째, 데이터베이스는 복제될 수 있다. 즉, 서로 다른 장소에 복수의 데아터베이스 사본을 저장할 수 있다는 것이다.
2. 둘째, 때론 데이터베이스 트랜잭션이 취소돼야 한다. 이를 트랜잭션 *복귀* 또는 *중단* 이라고 한다.



## 데이터베이스 복제

만약 여러분의 계좌를 가지고 있는 은행이 정보를 잃어버린다면 은행은 심각한 법적 처벌과 벌금에 처할 것이다. 이베이나 아마존 같은 온라인 쇼핑몰도 마찬가지다. 가장 널리 사용되는 방법은 중복 데이터 베이스(replicated database)다. 중복 데이터베이스는 데이터의 백업(backup) 개념과 다르다. 백업은 특정 시점의 스냅샷이다. 백업은 반드시 최신 상태를 유지하지 않는다. 반면, 중복 데이터베이스는 데이터베이스의 사본을 항상 동기화한다.

앞선 글에서 트랜잭션 도중 데이터베이스의 충돌 이후에도 트랜잭션이 완료될 수 있다고 설명하였다. 하지만 어떤 상황에서는 이조차 불가능할 수도 있다.  트랜잭션 도중 컴퓨터의 디스크 공간이 부족한 상황이 발생할 수 있기 때문이다. 트랜잭션이 각 복제본에 복사되는 도중에 어떠한 문제가 발생하면 트랜잭션을 복귀해야 할 경우가 있다는 것이다.

중복 데이터베이스에서 트랜잭션 복귀 문제를 살펴보자. 다른 복제본의 디스크 공간이 충분하지만 한 복제본은 디스크 공간이 부족하다면 어떻게 할까? 이것을 이해하기 위한 이야기를 풀어쓰면 다음과 같다.

> 당신과 세 친구가 최근 개봉한 영화를 보고 싶다. 하지만, 전화로만 영화 관람 계획을 공유해야한다. 
>
> 당신이 친구들에게 적합할 듯한 영화 시간을 결정해야 한다. 화요일 오후 8시를 선택하고 모든 친구에게 한 명씩 전화를 돌려가며 화요일 오후 8시가 괜찮은지 물어볼 것이다. 
>
> 마지막 한 친구가 화요일 8시가 어렵다면 어떨까? 이 경우 당신은 지금까지 한 작업을 모두 *'복귀'* 시키고 재 시작해야 한다.

이렇게 '약속을 잡는' 과정에 두 단계의 작업이 있다. 우선 날짜와 시간이 언제 가능한지를 연락 받는과정과 이 약속을 다른 친구에게 다시 확인하는 두 번째 단계가 있다. 컴퓨터 과학자들은 이를 2단계 커밋 프로토콜이라고 한다(준비 후 커밋 트릭).

첫 번째 단계는 '준비'이고 두 번째 단계는 최초 제안을 모두가 수용했는지를 확인하는 '결정' 또는 '중단' 단계가 된다.

이 이야기에도 데이터베이스 '잠금' 개념이 있다. 각 친구는 영화 관람 약속을 예정할 때 암묵적으로 화요일 8시에 다른 일정을 잡지 않기로 하는 것이다.



이제 준비 후 커밋 트릭이 중복 데이터베이스에 작용하는 원리를 그림으로 살펴보자. 일반적으로 복제본 중 하나는 트랜잭션을 조정하는 마스터 역할을 한다. A, B, C 데이터베이스 복제본이 있고, A가 마스터라고 가정하자. 



![image-20201008082600966](../images/image-20201008082600966.png)

[그림 1] 준비 후 커밋 트릭: 마스터 복제본 A는 두 개의 다른 복제본인 B, C를 조정하여 테이블에 새로운 데이터를 추가하게 한다. 이 떄, 준비 단계(Prepare)에서는 마스터가 모든 복제본이 트랜잭션을 완료할 수 있는지를 확인한다. 모두 확인이 되면, 마스터는 이 데이터를 완료하고 계속 보관하라고(commit) 모든 복제본에게 명령한다.

이 세 개의 그림은 복제 작업이 문제 없이 완료될 경우를 순차적으로 표현한다.

첫 번째로 준비 단계에서는 A가 테이블을 잠그고 새로운 데이터를 A의 미리 쓰기 로그에 쓰는 것이다. 동시에 A는 새로운 데이터를 B와 C로 보내어 B와 C는 복제 작업 성공 여부를 A에게 보고한다. 이제 두 번째 단계가 시작할 차례다. A, B, C 중 하나가 (디스크 공간이 부족하거나, 교착상태) 문제가 발생하면 마스터 A는 처음부터 트랜잭션을 시작해야 한다는 것이다. 



![image-20201008131604944](../images/image-20201008131604944.png)[그림 2] 준비 후 커밋 트릭에서 복귀: 맨 위 그림은 앞선 그림과 동일하다. 그러나 준비(prepare) 단계에서 한 복제본이 오류가 발생한다. 따라서 마지막 그림은 각 복제본에서 트랜잭션을 복귀하는 '중단'단계가 된다.



---

미래를 바꾼 아홉가지 알고리즘. 존 매코믹 지음. 민병교 옮김. 2012. 에이콘

