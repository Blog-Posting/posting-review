# CHAPTER 02 TCP/IP의 데이터를 전기 신호로 만들어 보낸다. - 上

## 프로토콜 스택과 LAN 어댑터의 탐험



---

CHAPTER 01 웹브라우저 -> `CHAPTER 02 프로토콜 스택 & LAN 어댑터`

---
`1. 소켓을 작성한다`

`2. 서버에 접속한다`

3\. 데이터를 송 · 수신한다

4\. 서버에서 연결을 끊어 소켓을 말소한다

5\. IP와 이더넷의 패킷 송 · 수신 동작

6\. UDP 프로토콜을 이용한 송 · 수신 동작

---
*들어가기에 앞서*

저번 챕터에서는 브라우저가 요청 메시지를 작성하고 이를 프로토콜 스택에 전달하는 과정까지 살펴보았다. 이번 챕터에서는 본격적으로 프로토콜 스택에서 어떻게 데이터를 주고 받는지 알아보도록 하겠다.

---

## 1. 소켓을 작성한다.

### (1). 프로토콜 스택의 구성

저번 포스팅에서도 다뤘지만 프로토콜 스택은 `OS에 내장된 네트워크 제어용 소프트웨어`이다. 이번 포스팅에서는 프로토콜 스택에 대해 좀 더 본격적으로 알아보도록 하자.

![](https://raw.githubusercontent.com/Blog-Posting/posting-review/d190678acd6aae3de5aac09075b13b6ce0b7b0a0/network_basic/img/2/protocol%20stack_1.PNG)

* 그림에서 윗 부분은 애플리케이션 영역이다. 여기서는 인터넷 브라우저라고 볼 수 있다. 

* `두번째 TCP, UDP, IP를 포함한 영역이 OS 내부의 프로토콜 스택이다.`

* 프로토콜 스택은 **계층구조**로 되어있고 상위의 계층이 하위의 계층에 작업을 의뢰하도록 되어있다.
*  상위 영역에는  TCP와 UDP가 포함된다. TCP와 UDP에 대해서는 추후에 자세히 설명하기로 하고 우선은 간단하게 이해하고 넘어가자.
* _TCP_ : 브라우저나 메일 등의 일반적인 애플리케이션이 데이터를 송수신 할 경우 사용
* _UDP_ : DNS 서버에 대한 조회 등 짧은 제어용 데이터를 송수신할 경우 사용
* 그 아래에는 IP를 사용하여 패킷의 송수신 동작을 제어하는 부분이다.
* IP의 `주 역할은 패킷을 통신 상대까지 운반하는 것 `이다.
* _패킷_ :  네트워크에서 데이터를 운반할 때 작은 덩어리로 분할하여 운반하는데, 이때 작은 데이터 덩어리를 패킷이라 한다.
* 정리하자면 프로토콜 스택의 내부는 TCP와 UDP가 차지하는 상위 계층과 IP가 차지하는 하위계층으로 이루어져 있다.

### (2) 소켓의 실체

* 소켓에 대해 다시 언급하자면, `소켓이란 데이터를 주고 받는 통로(=파이프)의 입출구`를 뜻한다.
* 소켓은 개념적인 것에 가깝지만 실체를 꼽자면 `프로토콜 스택의 내부에 제어 정보를 기록하는 메모리 영역`이라고 볼 수 있다.
* 소켓에 저장되는 제어 정보에는 _통신상대의 IP주소, 포트 번호, 통신 동작의 진행 상태, 요청 후 경과 시간, 응답 여부_ 등이 있다.
* 프로토콜 스택은 소켓에 기록된 제어 정보를 참조하면서 움직인다.

### (3) 소켓 작성

* 소켓이 작성되는 과정을 살펴보면, 먼저 브라우저가 Socket 라이브러리를 호출하여 소켓 생성을 의뢰하고,  Socket 라이브러리는 이를  다시 프로토콜 스택에 의뢰하여 소켓을 만들게 된다.
* 브라우저 -> Socket 라이브러리 -> 프로토콜 스택 -> 소켓 생성
* 프로토콜 스택이 의뢰를 받으면 `소켓 한 개 분량의 메모리 영역을 확보하고, 초기 상태라는 것을 이 영역에 기록`함으로써 소켓을 생성하게 된다.
* 위의 과정으로 소켓이 생성되면 해당 소켓에 대한 번호표인 *디스크립터*를 애플리케이션에 알려주게 된다.

---

## 2. 서버에 접속한다.

### (1) 접속의 의미
* 서버의 IP주소와 포트 번호를 프로토콜 스택에 알림.
* 클라이언트측에서 서버측에 통신 동작의 개시를 전달.
* `제어 정보`를 주고받아 소켓에 필요한 정보를 기록.
* 송수신 데이터를 일시적으로 저장하는 메모리 영역인 `버퍼 메모리`의 확보.

### (2) 제어 정보
제어 정보는 통신 동작의 방향을 핸들링하는 키잡이 역할을 하기 때문에 매우 중요하다.

제어 정보의 종류는 두가지가 있다. 한가지는 `헤더에 기록되는 제어 정보`이고, 다른 하나는 `소켓에 기록되는 제어 정보`이다.
* 헤더에 기록되는 제어 정보
  * 패킷의 가장 앞부분에는 헤더가 있는데 이 헤더에 **클라이언트와 서버가 서로 연락을 절충하기 위해 주고받는 제어정보**가 담겨있다.
  ![](https://raw.githubusercontent.com/Blog-Posting/posting-review/d190678acd6aae3de5aac09075b13b6ce0b7b0a0/network_basic/img/2/header-packet.PNG)
  * 헤더의 종류는 다양하다. IP헤더, TCP헤더, UDP헤더 등 프로토콜에 따라 각각 다른 헤더 형식이 존재한다.


  * 예를 들어 TCP 헤더의 경우 송신지, 수신지에 대한 정보와 현재 몇번째 패킷을 보내고 받았는지를 등의 제어정보가 담겨 있다.
  
    ![](https://raw.githubusercontent.com/Blog-Posting/posting-review/d190678acd6aae3de5aac09075b13b6ce0b7b0a0/network_basic/img/2/tcp_header.PNG)

* 소켓에 기록되는 제어 정보
  * 소켓에 기록되는 제어 정보는 **프로토콜 스택을 제어하는 역할**을 한다.
  * 예를 들어 애플리케이션에서 통지된 정보, 통신 상대로부터 받은 정보, 송수신 동작의 진행 상황 등이 기록된다.

### (3) 접속 동작의 실제
접속 동작의 실제 과정을 요약하면 다음과 같다. 이 과정이 완료되면 흔히 파이프 혹은 커넥션이 연결되었다고 한다.

```
 Socket 라이브러리의 connect 호출
 -> 프로토콜 스택에 전달 
 -> 프로토콜 스택의 TCP 담당부분에서 TCP 헤더 작성 
 -> 프로토콜 스택 IP 담당 부분에 송신 의뢰 
 -> IP 담당 부분에서 헤더가 담긴 패킷 송신 
 -> 수신처에서 패킷 수신 
 -> 소켓에 제어 정보 기록
```
